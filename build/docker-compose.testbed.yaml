include:
  - roscore_service.yaml

services:
  agent:
    build:
      dockerfile: build/docker/agent/Dockerfile
      context: ../
      args:
        USERNAME: ${USERNAME}
        USER_UID: ${USER_UID}
        USER_GID: ${USER_GID}
    init: true
    tty: true
    shm_size: 2gb
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: "all"
              capabilities: [ gpu ]
    # executes default command specified in agent Dockerfile
    # build/docker/agent/Dockerfile
    logging:
      driver: "local"
    environment:
      - DISPLAY
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - ROS_MASTER_URI=http://roscore:11311
      - CARLA_SIM_HOST=carla-simulator
      - ROS_HOSTNAME=agent
      - XDG_RUNTIME_DIR=/tmp/runtime-carla
      - ROUTE=/opt/leaderboard/data/routes_devtest.xml
      - DEBUG_WRAPPER_DEFAULT_HOST=0.0.0.0
      - SDL_VIDEO_X11_FORCE_EGL=1
      # Simple route without special scenarios
      # - ROUTE=/workspace/code/routes/routes_simple.xml
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
      # if you change the volume here also change the copy command
      # in ``build/docker/agent/Dockerfile
      - ../:/workspace
      # mount git config for dvc
      - ../.gitconfig:/home/carla/.gitconfig
      - ../:/workspace/
    networks:
      - ros
    command: |-
      bash -c "\
      rosmsg list && \
      sudo apt-get -y install ros-noetic-teb-local-planner &&\
      cd /catkin_ws/src/code &&\
      cd /catkin_ws &&\
      catkin_make -DCATKIN_WHITELIST_PACKAGES="teb_planner_pa_msgs"  && \
      catkin_make -DCATKIN_WHITELIST_PACKAGES="teb_planner_pa"  && \
      source devel/setup.bash &&\
      cd /catkin_ws &&\
      catkin_make -DCATKIN_WHITELIST_PACKAGES="sim"  && \
      catkin_make -DCATKIN_WHITELIST_PACKAGES="mapping" &&\
      roslaunch sim sim.launch"
  # git clone https://github.com/TUC-ProAut/ros_teb_planner.git &&\
